package main

import (
	"bot_personal_insurance/pkg/models"
	"bot_personal_insurance/pkg/parser"
	"bot_personal_insurance/pkg/utils"
	"fmt"
	"log"
)

func main() {
	// Set the URL
	url := "https://app.bot.or.th/1213/MCPD/ProductApp/PLoanwithorwithoutCollateral/CompareProductList"

	// Create JSON payload
	initialPayload := `{"ProductIdList":"229,1591,8573,6545,8529,6536,3015,2967,2957,2974,2953,3008,2965,2977,3006,3007,2972,3014,3011,1592,5813,5812,7253,7254,7255,7256,3016,2983,2982,5811,5808,5810,2948,8447,8402,1262,5807,5806,1260,1265,8348,8387,8519,8377,8409,8384,7921,7915,7909,7925,7924,7927,7920,7911,7917,8522,8379,8275,8273,8578,8356,7916,7907,7913,877,875,6537,6539,6535,6541,6538,6543,6542,6544,1267,7912,7922,7923,8431,8415,8484,8316,8360,8314,8311,8461,8412,8254,8567,7908,7918,7914,1593,876,2996,2991,2956,2992,2976,2984,2968,3000,874,6540,1261,8495,8523,7926,8329,8490,8306,8331,8300,8341,8338,8358,8271,8463,8446,8485,8287,8298,8551,8393,7258,2955,2999,3010,2973,3017,2949,1436,7252,1434,7257,7919,8570,8259,8281,8464,8518,3888,231,8309,8336,8545,8497,8308,1002,7251,7259,2958,3002,2964,228,232,230,8258,8555,8442,8268,8474,8479,8284,8564,8382,8321,8417,8561,8394,8334,8457,8366,8420,8427,8371,8509,8500,8488,8257,8411,8381,8397,8532,8434,8546,8276,8398,8450,8449,8539,8430,8416,2990,8310,8571,8426,8504,8524,8264,8444,8549,8293,8424,8262,8562,8297,8344,8330,7910,8516,8472,8580,8299,8547,8569,8304,8493,8454","Page":1,"Limit":3}`
	// initialPayload := `{"ProductIdList":"229,1591,8573,6545,8529,6536,3015,2967,2957,2974,2953,3008,2965,2977,3006,3007","Page":1,"Limit":3}`

	firstPageBody, err := parser.FetchHTML(url, initialPayload)
	if err != nil {
		log.Fatalf("Error fetching first page: %v", err)
	}

	totalPages := parser.DetermineTotalPage(firstPageBody)
	if totalPages == 0 {
		log.Fatalf("Could no determine the total number of pages")
	}

	var personalLoans []models.PersonalLoan

	for page := 1; page <= totalPages; page++ {
		fmt.Printf("Processing page: %d/%d\n", page, totalPages)
		payload := fmt.Sprintf(`{"ProductIdList":"229,1591,8573,6545,8529,6536,3015,2967,2957,2974,2953,3008,2965,2977,3006,3007,2972,3014,3011,1592,5813,5812,7253,7254,7255,7256,3016,2983,2982,5811,5808,5810,2948,8447,8402,1262,5807,5806,1260,1265,8348,8387,8519,8377,8409,8384,7921,7915,7909,7925,7924,7927,7920,7911,7917,8522,8379,8275,8273,8578,8356,7916,7907,7913,877,875,6537,6539,6535,6541,6538,6543,6542,6544,1267,7912,7922,7923,8431,8415,8484,8316,8360,8314,8311,8461,8412,8254,8567,7908,7918,7914,1593,876,2996,2991,2956,2992,2976,2984,2968,3000,874,6540,1261,8495,8523,7926,8329,8490,8306,8331,8300,8341,8338,8358,8271,8463,8446,8485,8287,8298,8551,8393,7258,2955,2999,3010,2973,3017,2949,1436,7252,1434,7257,7919,8570,8259,8281,8464,8518,3888,231,8309,8336,8545,8497,8308,1002,7251,7259,2958,3002,2964,228,232,230,8258,8555,8442,8268,8474,8479,8284,8564,8382,8321,8417,8561,8394,8334,8457,8366,8420,8427,8371,8509,8500,8488,8257,8411,8381,8397,8532,8434,8546,8276,8398,8450,8449,8539,8430,8416,2990,8310,8571,8426,8504,8524,8264,8444,8549,8293,8424,8262,8562,8297,8344,8330,7910,8516,8472,8580,8299,8547,8569,8304,8493,8454","Page":%d,"Limit":3}`, page)

		pageBody, err := parser.FetchHTML(url, payload)
		if err != nil {
			log.Printf("Error fetching data for page %d: %v", page, err)
			continue
		}

		loans, err := parser.ParsePersonalLoanDetails(pageBody)
		if err != nil {
			log.Printf("Error parsing loan details for page %d: %v", page, err)
			continue
		}
		personalLoans = append(personalLoans, loans...)
	}

	err = utils.WriteJSON(personalLoans, "personal_loan_insurance.json")
	if err != nil {
		log.Fatalf("Error writing JSON file: %v", err)
	}

	fmt.Println("Personal loan data has been saved to personal_loan_insurance.json")
}
